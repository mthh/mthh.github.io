class: first

# Des donn√©es √† la cartographie

<br>

### M1 GAED-GEOMAS / M1 GAED-GEOPOESICE

<br>
<br>

### Partie 1 : Cartographie th√©matique et mise en sc√®ne de la carte

<div style="width: 167px;position: absolute;bottom: -5px;left: 0px;">

<img src="img/logo-uga.jpg" />

</div>

<div style="margin: auto; text-align: center; position: relative; bottom: -150px; left: 20px;">
<p style="font-size: 20px;margin:auto; text-align: center">Matthieu Viry - LIG <em>(Laboratoire d'Informatique de Grenoble)</em></p>
<p style="font-size: 20px;margin:5px auto; text-align: center">üñÇ <a href="maito:matthieu.viry@univ-grenoble-alpes.fr">matthieu.viry@univ-grenoble-alpes.fr</a></p>
</div>

---
class: section-change

# S√©ance 3


---

## But du TP

<br><br>

- **R√©aliser des cartes th√©matiques avec R**

- **Maitriser l'ensemble de la chaine de traitement**, de la r√©cup√©ration des donn√©es √† l'export cartographique dans un seul environnement

- **S'inscrire dans une d√©marche de recherche reproductible**

---

## La recherche reproductible

<br>

- Les sciences se reposent sur le principe de reproductibilit√©

- La [reproductibilit√©](https://en.wikipedia.org/wiki/Reproducibility#Reproducible_research) est un √©l√©ment permettant d'√©valuer la validit√© des r√©sultats

.center.img60[![](img/reproducible-inrae.png)]

.center.source.small[Source : INRAE]

???

Les recherches empiriques en sciences humaines et sociales n√©cessitent la manipulation de nombreuses donn√©es, de multiples programmes pour leur gestion, leur analyse statistique, les estimations √©conom√©triques, les simulations‚Ä¶

Cette rigueur d√©bouche sur une recherche reproductible, qui assure que l‚Äôensemble des traitements et analyses r√©alis√©s depuis les donn√©es brutes jusqu‚Äô√† la publication finale sont tra√ßables et reproductibles. Elle am√®ne une transparence dans les recherches, assurant fiabilit√© et confiance dans les r√©sultats publi√©s.

Les cartes, comme les autres productions graphiques ou statistiques sont des √©l√©ments √† parts enti√®res des √©tudes scientifiques.


---

## La recherche reproductible

<br>

Plusieurs principes :

- **organisation des √©tapes du projet et leur documentation**

- **√©criture de programmes compr√©hensibles**

- **n√©cessit√© de l‚Äôautomatisation des √©tapes au sein des recherches**

.source.center.small[Source : INRAE]


.center.img85[![](img/peng2011.jpeg)]
.source.center.small[Source : Peng (2011)]

???


Le premier principe porte sur **l‚Äôorganisation des √©tapes du projet et leur documentation**. Des outils peuvent aider les chercheurs √† avoir une organisation plus structur√©e de la documentation des diff√©rentes t√¢ches d‚Äôun projet. Des pratiques assez simples sont propos√©es pour organiser les dossiers et suivre les flux de travail, comme le partage des fichiers, la gestion des versions et l‚Äô√©criture collaborative.

Le deuxi√®me principe concerne **l‚Äô√©criture de programmes compr√©hensibles**. Il faut veiller √† ce que les codes √©crits puissent √™tre lus par d‚Äôautres ou retravaill√©s ult√©rieurement. Pour ce faire, il est int√©ressant d‚Äôadopter des conventions de mise en forme et de d√©nomination des variables. Le code doit √™tre modularis√© pour √™tre clair, lisible et r√©utilisable.

Le troisi√®me principe porte sur **la n√©cessit√© de l‚Äôautomatisation des √©tapes au sein des recherches**. Et ce, afin d‚Äô√©viter tout traitement manuel et de r√©duire les erreurs. Cela permet √©galement d‚Äôaugmenter la reproductibilit√© des r√©sultats depuis les donn√©es originelles.



---

## La recherche reproductible - cartographie

<br><br>

Pourquoi ?

- Garder une trace des traitements effectu√©s
- Partager ses m√©thodes
- √ätre transparent, s‚Äôexposer √† la critique
- Faciliter les mises √† jour
- Travailler collectivement
- Automatiser des taches
- Lier fortement l‚Äôanalyse et la repr√©sentation

.source[D'apr√®s Timoth√©e Giraud (2019)]

---

## La recherche reproductible - cartographie

<br>

Une reproductibilit√© rendue difficile ...

<br>

.center.img90[![](img/reprod-0.png)]

.center.source[Source : Timoth√©e Giraud (2019)]

---

## La recherche reproductible - cartographie

<br><br>

.center.img90[![](img/map-reprod.png)]

.center.source[Source : Giraud et Lambert (2017)]
---

## La recherche reproductible - cartographie

<br>

Des solutions existent pour simplifier les chaines de traitements et couvrir les diff√©rentes √©tapes ...

<br>

.center.img90[![](img/reprod-1.png)]


.center.source[Source : Timoth√©e Giraud (2019)]

---

## Le langage R

<br>

.center.img35[![](img/R-logo.png)]

<br>

- un **langage** et un **environnement** permettant de r√©aliser des **traitements statistiques** et des **repr√©sentations graphiques**

- un **logiciel libre** (sous license GNU General Public License)

- **multiplateforme** (GNU/Linux, Windows, OS X, etc.)

---

## Les outils disponibles en R

<br><br>

- Un large √©cosyst√®me de *packages*

- RStudio, un puissant IDE (environnement de d√©veloppement int√©gr√©)

- Une solution de [*literate programming*](https://en.wikipedia.org/wiki/Literate_programming) bas√©e sur le langage de balise `Markdown`

---

## Les outils disponibles en R pour le spatial

<br><br>

- `sf` : manipulation d'entit√© (*Simple Features*) avec des g√©om√©tries vectorielles

- `osmdata` : r√©cup√©ration de donn√©es OSM (via l'API OverPass)

- `terra` : manipulation de donn√©es raster

- `mapsf` : cartographie

---

## Les outils disponibles en R pour le spatial

<br><br>

.center.img75[![](img/sf-diagram.png)]

.center.source[Source : Pebesma and Bivand (2020)]

---

## Les outils disponibles en R pour le spatial

<br>

On va s'appuyer sur ces outils pour mettre en place une cha√Æne de traitement reproductible.

<br><br>

.center.img75[![](img/mapsf-reprod.png)]

.center.source[Source : Timoth√©e Giraud (2021)]

---

## Mapsf

<br>

- Impl√©mente les **m√©thodes de cartographie th√©matique traditionnelles** vues jusqu'ici

- Carte **choropl√®the**, **symboles proportionnels**, etc.

- Permet de **personnaliser la carte** : couleurs, disposition des √©l√©ments, ajout d'√©l√©ments d'habillage (carton, graphique, logo, etc.)

- Permet un **affichage dans l'IDE** ou un **export en PNG ou SVG**

- Une **API simple et proche des besoins de l'utilisateur-cartographe**

- **Document√©**, avec de nombreuses ressources (vignettes, cheatsheet, etc.) : https://riatelab.github.io/mapsf/

---

## Mapsf - 9 types de cartes

<br>

.center.img55[![](img/mapsf-type-maps.png)]

---

## Mapsf - exemples (1)

.center[![](img/example-mtq.png)]

---

## Mapsf - exemples (1)

```R
library(mapsf)

mtq <- mf_get_mtq() # Donn√©es d'exemple

mf_map(x = mtq) # Fond de carte

# Symboles proportionnels
mf_map(x = mtq, var = "POP", type = "prop")

mf_inset_on(x = "worldmap", pos = "topright") # Start an inset map

mf_worldmap(mtq, col = "#0E3F5C") # Plot martinique position on it

mf_inset_off() # Close the inset

# Plot a map layout
mf_layout(title = "Population municipale en Martinique",
          credits = "M.V., 2022; Sources: INSEE & IGN, 2018")
```


---

## Mapsf - exemples (2)

.center[![](img/example-mtq2.png)]

---

## Mapsf - exemples (2)

```R
library(mapsf)

mf_init(x = mtq, theme = "agolalight")
# Ombrage √† la couche martinique
mf_shadow(mtq, col = "grey10", add = TRUE)
# Carte choropl√®the sur la variable "MED"
mf_map(x = mtq, var = "MED", type = "choro",
       pal = "Dark Mint",
       breaks = "quantile",
       nbreaks = 6,
       leg_title = "Median Income\n(euros)",
       leg_val_rnd = -2,
       add = TRUE)
# Start an inset map
mf_inset_on(x = "worldmap", pos = "right")
# Plot martinique position on it
mf_worldmap(mtq, col = "#0E3F5C")
# Close the inset
mf_inset_off()
# Plot a title
mf_title("Wealth in Martinique, 2015")
# Plot credits
mf_credits(
  "M.V., 2022\nSources: INSEE & IGN, 2018"
)
# Plot a scale bar
mf_scale(size = 5)
# Plot a north arrow
mf_arrow('topleft')
```

---

## L'exercice du jour !

<br>

- **Analyser les prix de l'immobilier √† Grenoble, √† travers du prix de vente au m¬≤ des appartements**

- Un jeu de donn√©es disponibles : [Demandes de valeurs fonci√®res g√©olocalis√©es (DVF)](https://www.data.gouv.fr/fr/datasets/demandes-de-valeurs-foncieres-geolocalisees/)

---
## Attendus

<br>

.small[
- **Script comment√© ou document `R Markdown` permettant de reproduire l'ensemble de la cha√Æne de traitement** (de la r√©cup√©ration des donn√©es jusqu'√† l'obtention des cartes), permettant de restituer l'information concernant **le prix de vente au m¬≤ des appartements √† Grenoble**, au travers des √©l√©ments suivants :

  - **Une carte pr√©sentant l'information de mani√®re d√©taill√©e et ponctuelle** (point) - cette carte doit √™tre correctement habill√©e et mise en sc√®ne (i.e. on doit y voir les √©l√©ments structurant du territoire grenoblois : cours d'eau, grands parcs, routes, etc.).

  - **Une carte, √† √©chelle plus fine, pr√©sentant les prix au m¬≤ dans le voisinage** (rayon de 300m) **de la gare SNCF de Grenoble**.

  - **Une carte pr√©sentant l'information de mani√®re plus synth√©tique et avec une repr√©sentation surfacique** (dans une maille d'analyse) - il est n√©cessaire que vous trouviez le maillage le plus pertinent pour aggr√©ger l'information et pour la restituer.
]

---
## Lancement de l'exercice

<br><br>

- Quelles donn√©es ? (DVF, mais aussi ... ?)

- Comment t√©l√©charger / d√©compresser / charger les donn√©es en R ?

- Quels traitements sur les donn√©es ? (s√©lection, nettoyage, etc.)

- Quels modes de repr√©sentation ?

- Comment documenter les op√©rations ? (script comment√©, document R Markdown, etc.)

---

### 1. Constitution des groupes

<br><br><br>

- **Constituer des groupes entre 2 et 4 personnes** (pr√©requis : minimum une personne par groupe qui fait d√©j√† du R)

<br>

----

.center[**_Env. 5min_**]


---

### 2. R√©flexion sur les donn√©es √† utiliser et les repr√©sentations √† mettre en oeuvre

<br>
.center[*Pas encore dans RStudio !*]
<br><br>

- Par groupe, r√©fl√©chir aux **donn√©es qui pourraient √™tre utiles** (pour mener l'analyse et pour habiller les cartes) - **les lister** !

- Par groupe, r√©fl√©chir aux **repr√©sentations qui pourraient √™tre mise en oeuvre**

- Par groupe, r√©fl√©chir au **mode de rendu choisi (R Markdown, script R comment√©, etc.)**

<br>

----

.center[**_R√©flexion : env. 20min_**]
.center[**_D√©brief : env. 15min_**]

---

### 3. T√©l√©chargement et import des donn√©es

<br><br>
.center[*On met enfin les mains dans le cambouis ...!*]
<br><br>

- Savez-vous **t√©l√©charger des donn√©es en R** ?

- Savez-vous **d√©compresser des donn√©es en R** (zip, 7z, etc.) ?

<br>

----

.center[**_Point de cours en R si besoin : env. 15min_**]

---

### 4. Pr√©paration des donn√©es

<br><br><br>

- **Chargement des donn√©es** (`data.frame`, objets spatiaux `sf`, etc.)

- **Transformation** / **s√©lection / **nettoyage des donn√©es**

<br>

----

.center[**_Point de cours en R si besoin : env. 15min_**]

---

### 5. Mise en oeuvre des repr√©sentations choisies

<br><br><br>

- R√®gles de **symbologie graphique**, **habillage de la carte**, etc.

- Affichage de la carte dans l'IDE vs. export PNG/SVG

- ... √Ä vous de jouer !

<br>

----

.center[**_Point de cours en R si besoin : env. 15min_**]

---

### Exemple d'habillage et d'emprise pour la premi√®re carte ...

.center.img95[![](img/map0.png)]


---

## Bibliographie, ressources - recherche reproductible

<br>

.small[
- [Peng, 2011. **Reproducible Research in Computational Science**, Science, Vol 334, Issue 6060, pp. 1226-1227](https://europepmc.org/backend/ptpmcrender.fcgi?accid=PMC3383002&blobtype=pdf)

- [INRAE, 2021. **Vers une recherche reproductible en sciences humaines et sociales**](https://www.inrae.fr/actualites/recherche-reproductible-sciences-humaines-sociales)

- [Rey-Coyrehourcq, Cura, Nuninger, Gravier, Nahassia, et al., 2017. **Vers une recherche reproductible dans un cadre interdisciplinaire : enjeux et propositions pour le transfert du cadre conceptuel et la r√©plication des mod√®les**. In Sanders L. (ed.), Peupler la terre. De la pr√©histoire √† l'√®re des m√©tropoles, Presses universitaires Fran√ßois Rabelais, pp.409-434](https://hal.archives-ouvertes.fr/hal-01677950/document)

- [Giraud, Lambert, 2017. **Reproducible Cartography.** In Peterson M (ed.), Advances in Cartography and GIScience. ICACI 2017. Lecture Notes in Geoinformation and Cartography, pp. 173-183](https://link.springer.com/chapter/10.1007/978-3-319-57336-6_13)
]

---

## Bibliographie, ressources - cartographie avec R

<br>

.small[
- [Giraud, 2021. **Cr√©er des cartes reproductibles avec mapsf**](https://rcarto.github.io/ined2021/)

- [Giraud, P√©cout, 2022. **G√©omatique avec R**](https://rcarto.github.io/geomatique_avec_r/)

- [Giraud, P√©cout, 2022. **Cartographie avec R**](https://rcarto.github.io/cartographie_avec_r/)

- [Lambert, 2021. **R√©aliser une carte de discontinuit√©s en 2,5D**, Rzine](https://rzine.fr/publication_rzine/20191125_ironcurtain/)

- [P√©cout, Giraud, 2022. **Introduction √† R - Statistique descriptive univari√©e et bivari√©e**](https://huguespecout.github.io/Initiation_R_stats/)
]
