
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="fr">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>Exercice 7 : Construction d’un plugin &#8212; Documentation PythonQGIS_TP </title>
    <link rel="stylesheet" href="_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/css/custom.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <script type="text/javascript" src="_static/js/custom.js"></script>
    <script type="text/javascript" src="_static/translations.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Recherche" href="search.html" />
    <link rel="next" title="Cheatsheet" href="cheatsheet.html" />
    <link rel="prev" title="Exercice 5 : Ouverture d’un raster et enrichissement d’une couche vecteur" href="ex5.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="Index général"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="cheatsheet.html" title="Cheatsheet"
             accesskey="N">suivant</a> |</li>
        <li class="right" >
          <a href="ex5.html" title="Exercice 5 : Ouverture d’un raster et enrichissement d’une couche vecteur"
             accesskey="P">précédent</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Documentation PythonQGIS_TP </a> &#187;</li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar">
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Contenu</h2>
    <div class="sidebar-localtoc">
      <ul>
<li><a class="reference internal" href="#">Exercice 7 : Construction d’un plugin</a><ul>
<li><a class="reference internal" href="#objectif">Objectif</a></li>
<li><a class="reference internal" href="#donnees-et-outils-necessaires">Données et outils nécessaires</a></li>
<li><a class="reference internal" href="#mise-en-situation">Mise en situation</a></li>
<li><a class="reference internal" href="#procedure">Procédure</a></li>
</ul>
</li>
</ul>

    </div>
  </div>
</div>
  <h4>Sujet précédent</h4>
  <p class="topless"><a href="ex5.html"
                        title="Chapitre précédent">Exercice 5 : Ouverture d’un raster et enrichissement d’une couche vecteur</a></p>
  <h4>Sujet suivant</h4>
  <p class="topless"><a href="cheatsheet.html"
                        title="Chapitre suivant">Cheatsheet</a></p>
  <div role="note" aria-label="source link">
    <h3>Cette page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/ex7.rst.txt"
            rel="nofollow">Montrer le code source</a></li>
    </ul>
   </div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="index.html">Docs</a></li>
              
              <li>Exercice 7 : Construction d’un plugin</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <div class="section" id="exercice-7-construction-d-un-plugin">
<h1>Exercice 7 : Construction d’un plugin<a class="headerlink" href="#exercice-7-construction-d-un-plugin" title="Lien permanent vers ce titre">¶</a></h1>
<div class="figure align-center" style="width: 98%">
<img alt="_images/ex7_logo_plugin_builder.png" src="_images/ex7_logo_plugin_builder.png" />
</div>
<div class="section" id="objectif">
<h2>Objectif<a class="headerlink" href="#objectif" title="Lien permanent vers ce titre">¶</a></h2>
<p>L’objectif de cet exercice est de créer un premier plugin pour QGIS.</p>
<p>L’outil <code class="docutils literal notranslate"><span class="pre">Qt</span> <span class="pre">Designer</span> <span class="pre">5</span></code> va être nécessaire pour construire l’interface graphique.</p>
<p>Dans le cas de l’utilisation de Windows, on préférera une installation de QGIS réalisée
avec <a class="reference external" href="https://www.qgis.org/fr/site/forusers/download.html#windows">OSgeo4W</a> qui donnera
accès à la possibilité d’installer facilement les composants nécessaires au développement
de plugins (tels que les outils <code class="docutils literal notranslate"><span class="pre">Qt</span> <span class="pre">Designer</span></code> et <code class="docutils literal notranslate"><span class="pre">pyuic5</span></code>) et d’accéder
à une console système paramétrée correctement pour les utiliser.</p>
</div>
<div class="section" id="donnees-et-outils-necessaires">
<h2>Données et outils nécessaires<a class="headerlink" href="#donnees-et-outils-necessaires" title="Lien permanent vers ce titre">¶</a></h2>
<div class="line-block">
<div class="line">-&gt; <strong>Qt Designer 5</strong> (normallement installé lors d’une nouvelle installation de QGIS)</div>
<div class="line">-&gt; Plugin QGIS <code class="docutils literal notranslate"><span class="pre">Plugin</span> <span class="pre">Builder</span></code></div>
</div>
</div>
<div class="section" id="mise-en-situation">
<h2>Mise en situation<a class="headerlink" href="#mise-en-situation" title="Lien permanent vers ce titre">¶</a></h2>
<p>Pour les besoins d’une structure territoriale qui doit fusionner ses communes,
nous devons développer un plugin proposant à l’utilisateur de <strong>sélectionner
des polygones voisins et de les fusionner</strong>.</p>
<p>Un formulaire sera ouvert pour permettre à l’utilisateur de <strong>saisir les nouveaux
attributs de cette entité</strong> (nom de la commune fusionnée, nouveaux code, etc.)</p>
<p>Une fois ces informations validées, les entités dont sont issues la fusion seront
supprimée de la couche en question.</p>
</div>
<div class="section" id="procedure">
<h2>Procédure<a class="headerlink" href="#procedure" title="Lien permanent vers ce titre">¶</a></h2>
<ul class="simple">
<li>Démarrer QGIS 3.</li>
<li>Installer l’extension <code class="docutils literal notranslate"><span class="pre">Plugin</span> <span class="pre">Builder</span></code> et l’extention <code class="docutils literal notranslate"><span class="pre">Plugin</span> <span class="pre">Reloader</span></code>
depuis le gestionnaire des extensions (Menu <code class="docutils literal notranslate"><span class="pre">Extension</span> <span class="pre">&gt;</span> <span class="pre">Gestionnaire</span> <span class="pre">des</span> <span class="pre">extensions</span></code>)</li>
</ul>
<div class="figure align-center" style="width: 98%">
<a class="reference internal image-reference" href="_images/ex7_extension.png"><img alt="_images/ex7_extension.png" src="_images/ex7_extension.png" style="width: 100%;" /></a>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">L’extension <code class="docutils literal notranslate"><span class="pre">Plugin</span> <span class="pre">Builder</span></code> va seulement être utilisée lors de la création du plugin.
Elle permet de créer l’ensemble des fichiers nécessaires au développement d’un plugin
et va nommer les fichiers et les prototypes de classes et de fichiers d’interface
au regard du nom et de la description donnée au plugin à créer.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">L’extension <code class="docutils literal notranslate"><span class="pre">Plugin</span> <span class="pre">Reloader</span></code> va permettre de recharger le plugin dans QGIS au cours de son développement.
Elle permet, en un clic, de charger la dernière version d’un plugin (à partir du répertoire d’installation par défaut des plugins : ~/.qgis2/python/plugins).
Cette extension est dans la catégorie extension expérimentale, si ce n’est pas déjà fait, il est nécessaire d’autoriser l’installation de ce type
d’extensions.</p>
</div>
<div class="figure align-center" style="width: 98%">
<a class="reference internal image-reference" href="_images/ex7_extension_exp.png"><img alt="_images/ex7_extension_exp.png" src="_images/ex7_extension_exp.png" style="width: 100%;" /></a>
</div>
<ul>
<li><p class="first">Ouvrir <code class="docutils literal notranslate"><span class="pre">Plugin</span> <span class="pre">Builder</span></code> (Menu <code class="docutils literal notranslate"><span class="pre">Extension</span> <span class="pre">&gt;</span> <span class="pre">Plugin</span> <span class="pre">Builder</span> <span class="pre">&gt;</span> <span class="pre">Plugin</span> <span class="pre">Builder</span></code>).</p>
</li>
<li><p class="first">Saisir les différentes informations demandées :</p>
<dl class="docutils">
<dt>Pour respecter les conventions Python :</dt>
<dd><ul class="first last simple">
<li>nom de classe en <em>CamelCase</em> <a class="footnote-reference" href="#f1" id="id1">[1]</a></li>
<li>nom du module en minuscule avec underscore si besoin <a class="footnote-reference" href="#f2" id="id2">[2]</a></li>
</ul>
</dd>
<dt>Pour respecter les conventions de publication des plugins QGIS :</dt>
<dd><ul class="first last simple">
<li>on évite le mot «&nbsp;plugin&nbsp;» dans la nom du plugin <a class="footnote-reference" href="#f3" id="id3">[3]</a></li>
</ul>
</dd>
</dl>
</li>
</ul>
<div class="figure align-center" style="width: 98%">
<img alt="_images/ex7_builder_fields.png" src="_images/ex7_builder_fields.png" />
</div>
<div class="figure align-center" id="id4" style="width: 98%">
<img alt="_images/ex7_builder_fields2.png" src="_images/ex7_builder_fields2.png" />
<p class="caption"><span class="caption-text">On choisi le type de template à utiliser pour la fenetre qui va être créée,
le nom qui sera utilisé dans le menu de QGIS et le menu dans lequel sera ajouté.</span></p>
</div>
<ul class="simple">
<li>Les panneaux suivants peuvent être laissés par défaut, à l’exception du dernier où il est
nécessaire de sélectionner l’emplacement à utiliser pour stocker le code généré pour ce plugin.</li>
</ul>
<div class="figure align-center" style="width: 98%">
<img alt="_images/ex7_builder_fields3.png" src="_images/ex7_builder_fields3.png" />
</div>
<ul>
<li><p class="first">Le développement de ce plugin va se passer en plusieurs étapes.
Dans un premier temps nous allons éditer le fichier <code class="docutils literal notranslate"><span class="pre">.ui</span></code> qui est utilisé par Qt.
Ces fichiers (au format XML) sont utilisé par Qt / PyQt pour générer du code (au format C++ dans le cas de Qt, en Python dans notre cas avec PyQt),
soit lors de l’éxécution du programme qui les appelle, soit lors d’une étape préalable de compilation.</p>
<p>Pour le besoin de notre plugin nous allons avoir besoin d’une liste déroulante
permettant de sélectionner à quelle couche doit s’appliquer le traitement.
Ce type d’élément s’apelle <code class="docutils literal notranslate"><span class="pre">QComboBox</span></code> dans Qt.</p>
<p>QGIS est fourni avec différents éléments facilitant le développement de plugin tels qu’une classe <code class="docutils literal notranslate"><span class="pre">QgsMapLayerComboBox</span></code> :
il s’agit d’une sous classe de <code class="docutils literal notranslate"><span class="pre">QComboBox</span></code> qui est directement alimentée par la liste des couches chargées dans QGIS.
Cet objet va également permettre de filter le type de couche à afficher en fonction de leur type de géométrie par exemple;
nous allons utiliser cette fonctionnalité.</p>
</li>
<li><p class="first">Les principales briques nécessaires pour écrire le code sont les suivantes :</p>
<ul>
<li><p class="first">Identifier les entités sélectionnées dans la couche demandé par l’utilisateur</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">selected</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">selectedFeatures</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p class="first">Fusionner les géométries de ces entités en une nouvelle géométrie. Cette opération est généralement appelée une union
(toutefois il s’agit d’un mot réservé en C++, la méthode a donc été appelée <code class="docutils literal notranslate"><span class="pre">combine</span></code> dans QGIS et donc par
extension dans PyQgis).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">geoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">ft</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span> <span class="k">for</span> <span class="n">ft</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">]</span>
<span class="n">merged_geom</span> <span class="o">=</span> <span class="n">QgsGeometry</span><span class="p">(</span><span class="n">geoms</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">for</span> <span class="n">geom</span> <span class="ow">in</span> <span class="n">geoms</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
    <span class="n">merged_geom</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first">Créer une nouvelle entité utilisant cette géométrie et ouvrir le formulaire proposant à l’utilisateur de saisir ses attributs.
/!Ne pas oublier que la couche doit être en mode édition (voir exercice 3) au moment de l’ouverture du formulaire,
comme au moment de l’ajout de la nouvelle entité ou au moment de la suppression des anciennes entités !</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">new_feature</span> <span class="o">=</span> <span class="n">QgsFeature</span><span class="p">()</span>
<span class="n">new_feature</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="n">merged_geom</span><span class="p">)</span>
<span class="n">new_feature</span><span class="o">.</span><span class="n">setFields</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">fields</span><span class="p">())</span>
<span class="n">validated</span> <span class="o">=</span> <span class="n">iface</span><span class="o">.</span><span class="n">openFeatureForm</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">new_feature</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">layer</span><span class="o">.</span><span class="n">dataProvider</span><span class="p">()</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="n">new_feature</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first">Gérer quelques erreurs possibles : les entités sélectionnées ne sont pas réellement voisines par exemple.</p>
</li>
<li><p class="first">Enlever les anciennes entités une fois que la nouvelle a été ajoutée avec succès :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">ft</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">:</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">deleteFeature</span><span class="p">(</span><span class="n">ft</span><span class="o">.</span><span class="n">id</span><span class="p">())</span>
</pre></div>
</div>
</li>
<li><p class="first">On va aussi définir une fonction qui affichera un message d’erreur si nécessaire:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">display_error</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
    <span class="n">iface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushMessage</span><span class="p">(</span>
        <span class="s2">&quot;Erreur&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">Qgis</span><span class="o">.</span><span class="n">Critical</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first">L’essentiel de la logique peut ainsi être résumée ainsi :</p>
<div class="spoiler blq docutils container">
<p>Solution :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">merge_selected_features</span><span class="p">(</span><span class="n">layer</span><span class="p">):</span>
    <span class="c1"># Récupération de la liste des entités (QgsFeature) sélectionnées :</span>
    <span class="n">selected</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">selectedFeatures</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">display_error</span><span class="p">(</span><span class="s1">&#39;Le nombre d</span><span class="se">\&#39;</span><span class="s1">entités sélectionné est insuffisant&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Déselectionne les entités sélectionnés :</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">removeSelection</span><span class="p">()</span>

    <span class="c1"># Récupération des géométries (QgsGeometry)</span>
    <span class="c1"># des entités sélectionnées :</span>
    <span class="n">geoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">ft</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span> <span class="k">for</span> <span class="n">ft</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">]</span>

    <span class="c1"># Fusion des entités dans la nouvelle géométrie &#39;merged_geom&#39; :</span>
    <span class="n">merged_geom</span> <span class="o">=</span> <span class="n">QgsGeometry</span><span class="p">(</span><span class="n">geoms</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">geom</span> <span class="ow">in</span> <span class="n">geoms</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">merged_geom</span> <span class="o">=</span> <span class="n">merged_geom</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>

    <span class="c1"># Création de la nouvelle entité utilisant cette géométrie</span>
    <span class="c1"># (il est nécessaire de lui dire les champs à utiliser</span>
    <span class="c1">#  avant l&#39;ouverture du formulaire)</span>
    <span class="n">new_feature</span> <span class="o">=</span> <span class="n">QgsFeature</span><span class="p">()</span>
    <span class="n">new_feature</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="n">merged_geom</span><span class="p">)</span>
    <span class="n">new_feature</span><span class="o">.</span><span class="n">setFields</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">fields</span><span class="p">())</span>

    <span class="c1"># Entre en mode édition :</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">startEditing</span><span class="p">()</span>

    <span class="c1"># Ouverture du formulaire relatif à la nouvelle entité :</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="n">iface</span><span class="o">.</span><span class="n">openFeatureForm</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">new_feature</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
        <span class="c1"># Sortie du mode édition sans valider d&#39;éventuels changements</span>
        <span class="c1"># et affichage d&#39;un message d&#39;erreur</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">display_error</span><span class="p">(</span><span class="s1">&#39;Erreur dans la saisie des attributs&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Ajout de la nouvelle entité :</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">dataProvider</span><span class="p">()</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="n">new_feature</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
        <span class="c1"># Sortie du mode édition sans valider d&#39;éventuels changements</span>
        <span class="c1"># et affichage d&#39;un message d&#39;erreur</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">display_error</span><span class="p">(</span><span class="s1">&#39;Erreur lors de l</span><span class="se">\&#39;</span><span class="s1">ajout de la nouvelle entité&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Suppression des entités dont est issues la fusion :</span>
    <span class="k">for</span> <span class="n">ft</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">:</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">deleteFeature</span><span class="p">(</span><span class="n">ft</span><span class="o">.</span><span class="n">id</span><span class="p">())</span>

    <span class="c1"># Validation des changements :</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">commitChanges</span><span class="p">()</span>
</pre></div>
</div>
</div>
</li>
<li><p class="first">Les étapes suivantes consistent à intégrer cette logique à notre plugin.</p>
</li>
<li><p class="first">Bonus : on veut vérifier que les poylgones à fusionner sont bien voisins.
Comment s’y prendre ? Pour deux polygones ? Pour 3, 4 ou un nombre indéterminé ?</p>
<div class="spoiler blq docutils container">
<p>Solution :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">all_touches_one_group</span><span class="p">(</span><span class="n">geoms</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Étant donné une liste de `QgsGeometry` cette fonction retourne un tuple</span>
<span class="sd">    dont le premier élément contient une valeur booléene (True / False, en</span>
<span class="sd">    fonction de si les géométries se touchent en formant un seul groupe)</span>
<span class="sd">    et dont le deuxième élément contient la raison si la réponse est False,</span>
<span class="sd">    ou un message vide sinon.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">geoms</span><span class="p">))}</span>
    <span class="c1"># Pour chaque géométrie on va créer une liste de</span>
    <span class="c1"># ses voisines directes</span>
    <span class="k">for</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">g1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geoms</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ix2</span><span class="p">,</span> <span class="n">g2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ix1</span> <span class="o">==</span> <span class="n">ix2</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">g1</span><span class="o">.</span><span class="n">touches</span><span class="p">(</span><span class="n">g2</span><span class="p">):</span>
                <span class="n">d</span><span class="p">[</span><span class="n">ix1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ix2</span><span class="p">)</span>

    <span class="c1"># Si au moins une d&#39;entre elles à cette liste de vide,</span>
    <span class="c1"># c&#39;est qu&#39;elle n&#39;a aucune voisine</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">li</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Au moins une géométrie est isolée&#39;</span><span class="p">)</span>

    <span class="c1"># Pas besoin de continuer les vérifications s&#39;il n&#39;y a que</span>
    <span class="c1"># deux géomtries, elles sont bien voisines :</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">geoms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># On va regarder si on peut parcourir l&#39;ensemble des géométries</span>
    <span class="c1"># en allant de géométrie qui se touche à géométrie qui se touche</span>

    <span class="c1"># Un `set` pour garder une trace des polygone parcourus</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># Une fonction récursive est définie pour parcourir les polygones</span>
    <span class="c1"># qui n&#39;ont pas encore été vus</span>
    <span class="k">def</span> <span class="nf">go_through</span><span class="p">(</span><span class="n">li</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">li</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">go_through</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>

    <span class="c1"># On applique cette fonction de manière arbitraire au premier polygone</span>
    <span class="n">start_list</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">start_list</span><span class="p">:</span>
        <span class="n">go_through</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span>

    <span class="c1"># On vérifie que le nombre de polygones parcourus est égal au</span>
    <span class="c1"># nombre de polygones en entrée, sinon c&#39;est qu&#39;il y a plusieurs</span>
    <span class="c1"># groupes distincts de polygones qui se touchent</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seen</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">geoms</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Les géométries sont en plusieurs groupes distincts&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</li>
</ul>
</li>
<li><p class="first">Sur windows ouvrir l’intépréteur de commande fournit à l’installation de QGIS en ouvrant
<code class="docutils literal notranslate"><span class="pre">Démarrer</span> <span class="pre">-&gt;</span> <span class="pre">Tous</span> <span class="pre">les</span> <span class="pre">programmes</span> <span class="pre">-&gt;</span> <span class="pre">OSGeo4W</span> <span class="pre">-&gt;</span> <span class="pre">OSGeo4W</span> <span class="pre">Shell</span></code></p>
</li>
<li><p class="first">Sur GNU/Linux ou Mac OS X ouvrir la console système habituelle.</p>
</li>
<li><p class="first">Se rendre dans le dossier choisit pour enregistrer le code de votre plugin.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Par exemple pour gnu/linux ou mac os x</span>
<span class="n">cd</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">mthh</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">neighbor_merger</span>

<span class="c1"># Par exemple pour windows</span>
<span class="n">cd</span> <span class="n">C</span><span class="p">:</span>\<span class="n">home</span>\<span class="n">matthieu</span>\<span class="n">code</span>
</pre></div>
</div>
</li>
<li><p class="first">Option 1 : Utiliser <code class="docutils literal notranslate"><span class="pre">make</span></code> pour préparer le code et le déplacer à l’emplacement des plugins QGIS.</p>
<ul class="simple">
<li>Utiliser l’utilitaire <code class="docutils literal notranslate"><span class="pre">Make</span></code> en tapant la commande <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">deploy</span></code>.</li>
</ul>
</li>
<li><p class="first">Option 2 : Recette manuelle :
Utiliser le chemin des plugins QGIS en fonction de votre plateforme (à partir de votre dossier personnel):</p>
<blockquote>
<div><ul class="simple">
<li>Linux:
<code class="docutils literal notranslate"><span class="pre">.local/share/QGIS/QGIS3/profiles/default/python/plugins/</span></code></li>
<li>Mac OS X:
<code class="docutils literal notranslate"><span class="pre">Library/Application</span> <span class="pre">Support/QGIS/QGIS3/profiles/default/python/plugins</span></code></li>
<li>Windows:
<code class="docutils literal notranslate"><span class="pre">AppData\Roaming\QGIS\QGIS3\profiles\default\python\plugins</span></code></li>
</ul>
</div></blockquote>
<p>Exécuter les commandes suivantes depuis la console système, et ce depuis le dossier
où est developpé le plugin :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">export</span> <span class="nv">QGISDIR</span> <span class="o">=</span> <span class="s2">&quot;le_chemin_approprié_comme_vu_au_dessus&quot;</span>
$ <span class="nb">export</span> <span class="nv">PLUGINNAME</span> <span class="o">=</span> <span class="s2">&quot;neighbor_merger&quot;</span>
$ pyuic5 -o xxxxxxxxxxxxxxx
$ pyuic5 -o xxxxxxxxxxxxxxx
$ rm -rf ~/<span class="k">$(</span>QGISDIR<span class="k">)</span>/python/plugins/<span class="k">$(</span>PLUGINNAME<span class="k">)</span>
$ mkdir -p ~/<span class="k">$(</span>QGISDIR<span class="k">)</span>/python/plugins/<span class="k">$(</span>PLUGINNAME<span class="k">)</span>
$ cp -vf *.py ~/<span class="k">$(</span>QGISDIR<span class="k">)</span>/python/plugins/<span class="k">$(</span>PLUGINNAME<span class="k">)</span>
$ cp -vf *.ui ~/<span class="k">$(</span>QGISDIR<span class="k">)</span>/python/plugins/<span class="k">$(</span>PLUGINNAME<span class="k">)</span>
$ cp -vf ressources.qrc ~/<span class="k">$(</span>QGISDIR<span class="k">)</span>/python/plugins/<span class="k">$(</span>PLUGINNAME<span class="k">)</span>
</pre></div>
</div>
</li>
</ul>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="f1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="https://www.python.org/dev/peps/pep-0008/#id41">https://www.python.org/dev/peps/pep-0008/#id41</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="https://www.python.org/dev/peps/pep-0008/#id40">https://www.python.org/dev/peps/pep-0008/#id40</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><a class="reference external" href="https://plugins.qgis.org/">https://plugins.qgis.org/</a></td></tr>
</tbody>
</table>
</div>
</div>


          </div>
            
  <div class="footer-relations">
    
      <div class="pull-left">
        <a class="btn btn-default" href="ex5.html" title="Chapitre précédent (use the left arrow)">Exercice 5 : Ouverture d’un raster et enrichissement d’une couche vecteur</a>
      </div>
    
      <div class="pull-right">
        <a class="btn btn-default" href="cheatsheet.html" title="Chapitre suivant (use the right arrow)">Cheatsheet</a>
      </div>
    </div>
    <div class="clearer"></div>
  
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="Index général"
             >index</a></li>
        <li class="right" >
          <a href="cheatsheet.html" title="Cheatsheet"
             >suivant</a> |</li>
        <li class="right" >
          <a href="ex5.html" title="Exercice 5 : Ouverture d’un raster et enrichissement d’une couche vecteur"
             >précédent</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Documentation PythonQGIS_TP </a> &#187;</li> 
      </ul>
    </div>
<script type="text/javascript">
  $("#mobile-toggle a").click(function () {
    $("#left-column").toggle();
  });
</script>
<script type="text/javascript" src="_static/js/bootstrap.js"></script>
  <div class="footer">
    &copy; Copyright 2019, Matthieu Viry. Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div>
  </body>
</html>